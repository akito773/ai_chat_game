class CharacterManager {
    constructor() {
        this.characters = {};
        this.currentCharacter = null;
        this.loadCharacters();
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async loadCharacters() {
        try {
            const response = await fetch('characters/characters.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            this.characters = await response.json();
            console.log('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', this.characters);
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¨­å®š
            const defaultCharacterId = Object.keys(this.characters)[0];
            if (defaultCharacterId) {
                this.selectCharacter(defaultCharacterId);
            }
        } catch (error) {
            console.error('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
            this.characters = {
                sakura: {
                    id: 'sakura',
                    name: 'ã•ãã‚‰ã¡ã‚ƒã‚“',
                    emoji: 'ğŸ‘§',
                    description: 'å…ƒæ°—ã„ã£ã±ã„ã®å­¦åœ’ã‚¢ã‚¤ãƒ‰ãƒ«â™ª',
                    personality: 'ã¨ã¦ã‚‚æ˜ã‚‹ãå…ƒæ°—ã§ã€ã„ã¤ã‚‚ç¬‘é¡”ã€‚å‹é”æ€ã„ã§ã€ã¿ã‚“ãªã‚’åŠ±ã¾ã™ã®ãŒå¾—æ„ã€‚',
                    greeting: 'ã“ã‚“ã«ã¡ã¯ã€œï¼ç§ã€ã•ãã‚‰ã§ã™â™ª\nä»Šæ—¥ã¯ã©ã‚“ãªãŠè©±ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã­ã€œâœ¨',
                    color: '#ff6b9d',
                    image: 'assets/images/sakura.png'
                }
            };
            this.selectCharacter('sakura');
        }
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ
    selectCharacter(characterId) {
        if (this.characters[characterId]) {
            this.currentCharacter = this.characters[characterId];
            this.updateUI();
            console.log('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ:', this.currentCharacter);
        }
    }

    // UIã‚’æ›´æ–°
    updateUI() {
        if (!this.currentCharacter) return;

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±è¡¨ç¤º
        const characterDisplay = document.getElementById('character-display');
        if (characterDisplay) {
            characterDisplay.innerHTML = `
                <div class="character-image">
                    <img src="${this.currentCharacter.image}" alt="${this.currentCharacter.name}"
                         onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\"font-size: 60px; color: ${this.currentCharacter.color};\\">${this.currentCharacter.emoji}</div>';">
                </div>
                <h2>${this.currentCharacter.name}</h2>
                <p class="character-description">${this.currentCharacter.description}</p>
            `;
        }

        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼å¤‰æ›´
        document.documentElement.style.setProperty('--character-color', this.currentCharacter.color);

        // æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        if (this.currentCharacter.greeting) {
            this.displayGreeting();
        }
    }

    // æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    displayGreeting() {
        const messagesDiv = document.getElementById('messages');
        if (messagesDiv) {
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            messagesDiv.innerHTML = '';
            
            // æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>${this.currentCharacter.name}:</strong><br>
                    ${this.currentCharacter.greeting.replace(/\n/g, '<br>')}
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }

    // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—
    getCurrentCharacter() {
        return this.currentCharacter;
    }

    // å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—
    getAllCharacters() {
        return this.characters;
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠUIã‚’è¡¨ç¤º
    showCharacterSelector() {
        const existingModal = document.querySelector('.character-modal');
        if (existingModal) {
            existingModal.remove();
        }

        const modal = document.createElement('div');
        modal.className = 'character-modal';
        modal.innerHTML = this.createCharacterSelector();
        document.body.appendChild(modal);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠUIã‚’ç”Ÿæˆ
    createCharacterSelector() {
        const characters = this.getAllCharacters();
        const currentId = this.currentCharacter?.id;

        let html = `
            <div class="character-selector">
                <h3>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</h3>
                <div class="character-grid">
        `;

        Object.values(characters).forEach(character => {
            const isActive = character.id === currentId ? 'active' : '';
            html += `
                <div class="character-card ${isActive}" onclick="characterManager.selectCharacter('${character.id}'); document.querySelector('.character-modal').remove();">
                    <div class="character-avatar" style="background-color: ${character.color}">
                        <img src="${character.image}" alt="${character.name}" 
                             onerror="this.style.display='none'; this.parentElement.innerHTML='${character.emoji}';">
                    </div>
                    <div class="character-info">
                        <div class="character-name-small">${character.name}</div>
                        <div class="character-desc-small">${character.description}</div>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
                <button onclick="document.querySelector('.character-modal').remove();" class="close-btn">é–‰ã˜ã‚‹</button>
            </div>
        `;

        return html;
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
const characterManager = new CharacterManager();

// DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤‰æ›´ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
document.addEventListener('DOMContentLoaded', function() {
    const changeCharacterBtn = document.getElementById('change-character-btn');
    if (changeCharacterBtn) {
        changeCharacterBtn.addEventListener('click', () => {
            characterManager.showCharacterSelector();
        });
    }
});

// === ç¢ºå®Ÿãªã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆä¿®æ­£ç‰ˆï¼‰ ===
// æ—¢å­˜ã®character-manager.jsã®æœ€å¾Œã«ç¢ºå®Ÿãªã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚’è¿½åŠ 

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šï¼ˆè¤‡æ•°ã®æ–¹æ³•ã§ç¢ºå®Ÿã«ï¼‰
function setupCharacterChangeButton() {
    const changeBtn = document.getElementById('change-character-btn');
    if (changeBtn) {
        console.log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤‰æ›´ãƒœã‚¿ãƒ³ç™ºè¦‹:', changeBtn);
        
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
        changeBtn.removeEventListener('click', handleCharacterChange);
        
        // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        changeBtn.addEventListener('click', handleCharacterChange);
        
        // onclickå±æ€§ã‚‚è¨­å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        changeBtn.onclick = handleCharacterChange;
        
        console.log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤‰æ›´ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
        return true;
    } else {
        console.error('âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤‰æ›´ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return false;
    }
}

// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
function handleCharacterChange(event) {
    event.preventDefault();
    console.log('ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤‰æ›´ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    
    if (window.characterManager) {
        characterManager.showCharacterSelector();
    } else {
        console.error('âŒ characterManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
}

// è¤‡æ•°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚’è©¦è¡Œ
document.addEventListener('DOMContentLoaded', setupCharacterChangeButton);
window.addEventListener('load', setupCharacterChangeButton);

// 3ç§’å¾Œã«ã‚‚å†è©¦è¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
setTimeout(() => {
    if (!setupCharacterChangeButton()) {
        console.log('ğŸ”„ 3ç§’å¾Œã®å†è©¦è¡Œã§ã‚‚ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }
}, 3000);

// === ç°¡å˜ãªã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆç·Šæ€¥ä¿®æ­£ç‰ˆï¼‰ ===
setTimeout(() => {
    const btn = document.getElementById('change-character-btn');
    if (btn) {
        console.log('âœ… ãƒœã‚¿ãƒ³ç™ºè¦‹ï¼ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šä¸­...');
        btn.onclick = function() {
            console.log('ğŸ¯ ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼');
            if (window.characterManager) {
                characterManager.showCharacterSelector();
            }
        };
        console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
    } else {
        console.log('âŒ ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
}, 1000);
