<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3B ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»ãƒãƒ£ãƒƒãƒˆçµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸš€ Phase 3B ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»ãƒãƒ£ãƒƒãƒˆçµ±åˆãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>ğŸ“– ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ </h2>
            <button class="test-button" onclick="testStoryContext()">ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—ãƒ†ã‚¹ãƒˆ</button>
            <div id="contextResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ’¬ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ </h2>
            <button class="test-button" onclick="testContextualChat()">ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ãƒ†ã‚¹ãƒˆ</button>
            <div id="chatResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="testFullIntegration()">ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆ</button>
            <div id="integrationResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h2>
            <button class="test-button" onclick="debugAllSystems()">å…¨ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</button>
            <div id="debugResult" class="result"></div>
        </div>
    </div>

    <script src="js/data/characters.js"></script>
    <script src="js/data/stories.js"></script>
    <script src="js/data/story-sakura.js"></script>
    <script src="js/data/story-misaki.js"></script>
    <script src="js/core/game-engine.js"></script>
    <script src="js/modules/save-manager.js"></script>
    <script src="js/modules/memory-manager.js"></script>
    <script src="js/modules/location-manager.js"></script>
    <script src="js/modules/relationship-manager.js"></script>
    <script src="js/modules/story-manager.js"></script>
    <script src="js/modules/story-context-manager.js"></script>
    <script src="js/modules/contextual-chat-system.js"></script>
    <script src="js/modules/story-ui.js"></script>
    <script src="js/modules/story-ui-extended.js"></script>
    <script src="js/modules/story-event-recorder.js"></script>

    <script>
        let gameEngine = null;
        let storyContextManager = null;
        let contextualChatSystem = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function initialize() {
            try {
                gameEngine = new GameEngine();
                gameEngine.registerModule('storymanager', new StoryManager(gameEngine));
                gameEngine.registerModule('storycontextmanager', new StoryContextManager(gameEngine));
                gameEngine.registerModule('contextualchatsystem', new ContextualChatSystem(gameEngine));
                await gameEngine.initialize();
                
                storyContextManager = gameEngine.modules.storycontextmanager;
                contextualChatSystem = gameEngine.modules.contextualchatsystem;
                
                if (storyContextManager) storyContextManager.initialize();
                if (contextualChatSystem) contextualChatSystem.initialize();
                
                console.log('âœ… Phase 3B ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                return true;
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        async function testStoryContext() {
            clearLog('contextResult');
            if (!storyContextManager) await initialize();
            
            try {
                log('contextResult', 'ğŸ“– ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—ãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                const sakuraContext = storyContextManager.getStoryContext('sakura');
                log('contextResult', `âœ… ã•ãã‚‰ã¡ã‚ƒã‚“ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—æˆåŠŸ`, 'success');
                log('contextResult', `   è¦ªå¯†åº¦: ${sakuraContext.relationshipStatus?.intimacy || 0}`);
                log('contextResult', `   åˆ©ç”¨å¯èƒ½ãƒãƒ£ãƒ—ã‚¿ãƒ¼: ${sakuraContext.currentProgress.availableChapters}`);
                
                const misakiContext = storyContextManager.getStoryContext('misaki');
                log('contextResult', `âœ… ãƒŸã‚µã‚­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—æˆåŠŸ`, 'success');
                log('contextResult', `   è¦ªå¯†åº¦: ${misakiContext.relationshipStatus?.intimacy || 0}`);
                log('contextResult', `   åˆ©ç”¨å¯èƒ½ãƒãƒ£ãƒ—ã‚¿ãƒ¼: ${misakiContext.currentProgress.availableChapters}`);
                
            } catch (error) {
                log('contextResult', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testContextualChat() {
            clearLog('chatResult');
            if (!contextualChatSystem) await initialize();
            
            try {
                log('chatResult', 'ğŸ’¬ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œãƒãƒ£ãƒƒãƒˆ ãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                const testMessages = ['éŸ³æ¥½ã«ã¤ã„ã¦è©±ã—ã¾ã—ã‚‡ã†', 'ã‚ãªãŸã®å¤¢ã¯ä½•ã§ã™ã‹ï¼Ÿ', 'æœ¬ã‚’èª­ã‚€ã®ã¯å¥½ãã§ã™ã‹ï¼Ÿ'];
                
                for (const message of testMessages) {
                    const sakuraResponse = contextualChatSystem.generateContextualResponse('sakura', message);
                    const misakiResponse = contextualChatSystem.generateContextualResponse('misaki', message);
                    
                    log('chatResult', `ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${message}`);
                    log('chatResult', `ğŸŒ¸ ã•ãã‚‰: ${sakuraResponse}`, 'success');
                    log('chatResult', `ğŸ“š ãƒŸã‚µã‚­: ${misakiResponse}`, 'info');
                    log('chatResult', '---');
                }
                
            } catch (error) {
                log('chatResult', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testFullIntegration() {
            clearLog('integrationResult');
            
            try {
                log('integrationResult', 'ğŸš€ ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                const initialized = await initialize();
                if (!initialized) {
                    log('integrationResult', 'âŒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—', 'error');
                    return;
                }
                log('integrationResult', 'âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
                
                // è¦ªå¯†åº¦ã‚’ä¸Šã’ã¦ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                const relationshipManager = gameEngine.modules.relationshipmanager;
                relationshipManager.modifyRelationship('sakura', 50);
                log('integrationResult', 'âœ… ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå®Œäº†', 'success');
                
                // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
                const context = storyContextManager.getStoryContext('sakura');
                log('integrationResult', `âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆå®Œäº† (è¦ªå¯†åº¦: ${context.relationshipStatus?.intimacy})`, 'success');
                
                // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œå¿œç­”
                const testMessage = 'éŸ³æ¥½ã«ã¤ã„ã¦è©±ã—ã¾ã—ã‚‡ã†';
                const response = contextualChatSystem.generateContextualResponse('sakura', testMessage);
                log('integrationResult', `âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ç”Ÿæˆå®Œäº†`, 'success');
                log('integrationResult', `   å¿œç­”: ${response}`);
                
                log('integrationResult', 'ğŸ‰ ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼', 'success');
                
            } catch (error) {
                log('integrationResult', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function debugAllSystems() {
            clearLog('debugResult');
            if (!gameEngine) await initialize();
            
            try {
                log('debugResult', 'ğŸ” å…¨ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³:');
                log('debugResult', `GameEngine: ${gameEngine ? 'âœ…' : 'âŒ'}`);
                log('debugResult', `StoryContextManager: ${storyContextManager ? 'âœ…' : 'âŒ'}`);
                log('debugResult', `ContextualChatSystem: ${contextualChatSystem ? 'âœ…' : 'âŒ'}`);
                
                if (gameEngine) {
                    const modules = Object.keys(gameEngine.modules);
                    log('debugResult', `ç™»éŒ²ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: ${modules.join(', ')}`);
                }
                
                if (window.StoryData) {
                    const characters = Object.keys(window.StoryData);
                    log('debugResult', `ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿: ${characters.join(', ')}`);
                }
                
            } catch (error) {
                log('debugResult', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ§ª Phase 3B ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
        });
    </script>
</body>
</html>